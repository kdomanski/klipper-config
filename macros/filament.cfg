[gcode_macro filament_unload]
variable_unload_temp_min: 210
variable_unload_len: 75
variable_unload_feed: 600
gcode:
  {% set target = printer.extruder.target %}

  heat up the extruder if it's too cold
  {% if printer.extruder.temperature < purge_temp_min %}
    STATUS_HEATING
    M109 S{purge_temp_min}
  {% endif %}

  SAVE_GCODE_STATE NAME=filament_unload
    STATUS_BUSY
    {% set epos = gcode_move.gcode_position['E'] %}
    M83 # extruder relative mode
    G1 E-{unload_len} F{unload_feed}
    G92 E{epos}
  RESTORE_GCODE_STATE NAME=filament_unload

  M104 S{target}
  {% if target == 0 %} # if we're cooling down all the way, let's accelerate it with the part cooling fan
    M106 S255
  {% endif %}
  STATUS_READY
   