[gcode_macro MACROS_VARS]
variable_ending_length:          25
variable_purge_length:           40
gcode:

[gcode_macro LAZY_HOME]
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %}
    STATUS_HOMING
    G28
  {% endif %}
  SKEW_PROFILE LOAD=default

[gcode_macro _RESET_EXTRUDER]
gcode:
    G92 E0

[gcode_macro _ENDING_RETRACTION]
gcode:    
     {% set RETRACT = printer["gcode_macro MACROS_VARS"].ending_length|default(0)%}
     G1 E{RETRACT*-1} F1800

[gcode_macro _milimeters_mode]
gcode:
  G21

[gcode_macro _ABSOLUTE_COORDINATES]
gcode:
  G90

[gcode_macro _RELATIVE_COORDINATES]
gcode:
  G91

[gcode_macro _ABSOLUTE_EXTRUSION]
gcode:
  M82

[gcode_macro _RELATIVE_EXTRUSION]
gcode:
  M83

[gcode_macro START_PRINT]
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}

  CLEAR_PAUSE

  # Start heating (but don't wait for it)
  STATUS_HEATING
  M140 S{BED_TEMP}

  _milimeters_mode
  _ABSOLUTE_COORDINATES
  LAZY_HOME

  STATUS_MESHING
  ;BED_MESH_CALIBRATE max_age=50
  LOAD_BED_MESH
  ADAPTIVE_BED_MESH FORCE_MESH=True

  STATUS_HEATING
  M190 S{BED_TEMP} ; wait for bed
  M109 S{EXTRUDER_TEMP} ; wait for extruder

  STATUS_CLEANING
  #BRUSH_NOZZLE
  PURGE_NOZZLE

  STATUS_PRINTING

[gcode_macro END_PRINT]
gcode:
  M104 S0 ; turn off temperature
  M140 S0 ; turn off heatbed
  M107 ; turn off fan

  ; raise the carriage
  M83
  G91
  G1 E-2 F2400
  G1 E-2 Z50 F2400

  _TOOLHEAD_PARK_PAUSE_CANCEL
  _ENDING_RETRACTION

  ;_SAVE_MESH_IF_SET
  M84 ; disable motors
  BED_MESH_CLEAR
  STATUS_PART_READY

[gcode_macro TUNE_HEATER]
description: Run PID calibration for the extruder heater
gcode:
  {% set TARGET = params.TARGET|default(240)|int %}
  {% if params.MOVE|default(1)|int %}
    G28
    STATUS_MESHING
    BED_MESH_CALIBRATE
    G90
    G0 X100 Y100 Z0.5 F2000
  {% endif %}
  STATUS_HEATING
  PID_CALIBRATE HEATER=extruder TARGET={TARGET}
  STATUS_READY
  {% if params.SAVE|default(0)|int %}
    SAVE_CONFIG
  {% endif %}

[gcode_macro LOAD_BED_MESH]
gcode:
  BED_MESH_PROFILE LOAD=default
